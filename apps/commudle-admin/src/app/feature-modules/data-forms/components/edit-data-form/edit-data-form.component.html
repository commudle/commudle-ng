<div class="data-form-container page-padding">
  <nb-card>
    <nb-card-header>
      <h3>Edit Form</h3>

      <div *ngIf="dataForm && dataForm.parent_type === 'Kommunity'">
        <button
          (click)="cloneCommunityDataForm()"
          class="clone-form-button"
          nbButton
          outline
          size="small"
          status="info"
        >
          Clone This Form
        </button>
      </div>
    </nb-card-header>
  </nb-card>
  <form [formGroup]="editDataForm" class="edit-data-form">
    <div formGroupName="data_form">
      <div class="save-button-top">
        <button
          (click)="updateDataForm()"
          [disabled]="!editDataForm.valid"
          fullWidth
          nbButton
          size="medium"
          status="primary"
          type="submit"
        >
          {{ submitButtonText() }}
        </button>
      </div>
      <nb-card>
        <nb-card-body>
          <div role="group">
            <div>
              <label fullWidth>
                Name*
                <input formControlName="name" fullWidth nbInput type="text"/>
              </label>
            </div>
          </div>

          <div role="group">
            <div>
              <label fullWidth>
                Description
                <textarea
                  formControlName="description"
                  fullWidth
                  nbInput
                  placeholder="Description (optional)"
                ></textarea>
              </label>
            </div>
          </div>
        </nb-card-body>
      </nb-card>

      <nb-card class="data-form-question-choices-container">
        <nb-card-body>
          <div
            *ngFor="let question of editDataForm['controls'].data_form['controls'].questions['controls']; let i = index"
            formArrayName="questions"
          >
            <div [formGroupName]="i" class="question-container">
              <div>
                <button
                  (click)="removeQuestionButtonClick(i)"
                  *ngIf="question.get('has_responses').value === false"
                  nbButton
                  outline
                  size="small"
                  status="danger"
                >
                  <fa-icon [icon]="faTrashAlt"></fa-icon>
                </button>
                <label>
                  {{ i + 1 }}. Question*
                  <input formControlName="title" fullWidth nbInput placeholder="Title*" required type="text"/>
                </label>
                <span
                  *ngIf="
                    question.get('title').touched &&
                    question.get('title').invalid &&
                    question.get('title').errors.required
                  "
                  class="validation-error-text"
                >
                  Required Field
                </span>
              </div>

              <div class="question-settings">
                <label>
                  Question Type
                  <nb-select
                    (selectedChange)="questionTypeChange($event, i)"
                    formControlName="question_type_id"
                    hero
                    placeholder="Question Type*"
                    required
                    size="tiny"
                    status="primary"
                  >
                    <nb-option *ngFor="let qt of questionTypes" [value]="qt.id">
                      {{ qt.name }}
                    </nb-option>
                  </nb-select>
                </label>
                <nb-checkbox formControlName="required" status="primary">Required</nb-checkbox>
                <nb-checkbox formControlName="disabled" status="primary">
                  Disabled <small>(If you don't want this question to appear anymore)</small>
                </nb-checkbox>
              </div>
              <div>
                <textarea
                  formControlName="description"
                  fullWidth
                  nbInput
                  placeholder="Description (optional)"
                ></textarea>
              </div>

              <div *ngIf="[4, 5].includes(question.get('question_type_id').value)">
                <div
                  *ngFor="let choice of question['controls'].question_choices['controls']; let chi = index"
                  class="choices-container"
                  formArrayName="question_choices"
                >
                  <div>
                    <div [formGroupName]="chi">
                      <input formControlName="title" nbInput placeholder="Enter Text*" required type="text"/>
                      <span
                        *ngIf="
                          choice.get('title').touched &&
                          choice.get('title').invalid &&
                          choice.get('title').errors.required
                        "
                        class="validation-error-text"
                      >
                        Required Field
                      </span>
                    </div>
                    <button
                      (click)="removeQuestionChoiceButtonClick(i, chi)"
                      *ngIf="choice.get('has_responses').value === false"
                      nbButton
                      size="tiny"
                      status="danger"
                    >
                      <fa-icon [icon]="faTrashAlt"></fa-icon>
                    </button>
                  </div>
                </div>
                <button (click)="addQuestionChoiceButtonClick(i)" hero nbButton size="tiny" status="primary">
                  <fa-icon [icon]="faPlus"></fa-icon>
                  &nbsp; Add Choice
                </button>
              </div>
            </div>
          </div>

          <div>
            <button (click)="addQuestionButtonClick()" nbButton size="medium" status="primary">
              <fa-icon [icon]="faPlus"></fa-icon>
              &nbsp; Add Question
            </button>
          </div>
        </nb-card-body>
      </nb-card>

      <div>
        <button
          (click)="updateDataForm()"
          [disabled]="!editDataForm.valid"
          fullWidth
          nbButton
          size="medium"
          status="primary"
          type="submit"
        >
          {{ submitButtonText() }}
        </button>
      </div>
    </div>
  </form>
</div>
