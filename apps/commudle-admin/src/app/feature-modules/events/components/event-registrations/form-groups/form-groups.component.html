<div class="event-data-form-groups">
  <div>
    <nb-list *ngIf="eventDataFormEntityGroups.length > 0" class="event-data-form-groups-list">
      <nb-list-item *ngFor="let edfeg of eventDataFormEntityGroups; let i = index">
        <div *ngIf="edfeg.data_form_entity" class="edfeg-details">
          <!-- form and payments details -->
          <div class="com-w-full md:com-w-96">
            <div class="com-flex com-mt-2 com-justify-between">
              <!-- form details -->
              <div class="form-details">
                <span class="edfeg-name"> {{ edfeg.name }}</span>
                <br />
                <span>
                  Form type:
                  {{ edfeg.registration_type.name | titlecase }}
                </span>
                <br />
                <a [routerLink]="['/forms', edfeg.data_form_entity.data_form_id, 'edit']" target="_blank">
                  Edit Form Questions
                </a>
              </div>
              <!-- paid button -->
              <div
                *ngIf="edfeg.registration_type.name !== ERegistrationTypeNames.FEEDBACK && community.payments_enabled"
                class="com-mt-2"
              >
                <nb-toggle (checkedChange)="onSwitchToggled(edfeg.id, i)" [checked]="edfeg.is_paid"> Paid </nb-toggle>
              </div>
            </div>

            <!-- link for open form -->
            <div class="com-flex com-justify-between md:com-justify-normal">
              <a
                *ngIf="event.editable"
                [routerLink]="['/fill-form', edfeg.data_form_entity.id]"
                class="link-to-fill"
                target="_blank"
              >
                <nb-icon icon="external-link" class="com-text-sm"></nb-icon>
                <span class="com-text-sm">Link to fill</span>
              </a>
              <div *appBreakpoints="'<=md'">
                <div
                  *ngIf="
                    [ERegistationTypes.ATTENDEE, ERegistationTypes.SPEAKER].includes(edfeg.registration_type.name) &&
                    event.editable
                  "
                >
                  <nb-toggle (checkedChange)="updateRSVP(edfeg.id, i)" [checked]="edfeg.rsvp_open === true">
                    Allow RSVP
                  </nb-toggle>
                </div>
              </div>
            </div>

            <!-- payment details -->
            <div *ngIf="edfeg.is_paid && community.payments_enabled" class="payment-details">
              <commudle-payment-settings
                [communityId]="community.id"
                [event]="event"
                [edfeg]="edfeg"
                [stripeAccounts]="stripeAccounts"
              ></commudle-payment-settings>
            </div>
            <div>
              <label class="switch">
                <input type="checkbox" (change)="onSwitchToggled(edfeg.id)" />
                <span class="slider round"></span>
              </label>
            </div>
          </div>

          <!-- stats and response -->
          <div
            class="com-flex com-items-center com-flex-row md:com-flex-col md:com-gap-8 com-justify-between md:com-justify-normal"
          >
            <div class="stats">
              <p><fa-icon [icon]="faUsers"></fa-icon> {{ edfeg.responses_count }}</p>
            </div>
            <a
              [queryParams]="{
                parent_type: 'EventDataFormEntityGroup',
                parent_id: edfeg.id,
                data_form_id: edfeg.data_form_entity.data_form_id
              }"
              [routerLink]="['/admin/communities', community.slug, 'event-dashboard', event.slug, 'form-responses']"
              nbButton
              size="small"
              status="info"
            >
              Show Responses
            </a>
          </div>

          <!-- change status and rsvp  -->
          <div class="com-flex com-flex-row md:com-flex-col md:com-gap-8 com-justify-between md:com-justify-normal">
            <div class="dropdown">
              <select (change)="changeVisibility($event, edfeg.data_form_entity.id)" class="com-border-0">
                <option
                  value="{{ visibilityOptions.YET_TO_ANNOUNCE }}"
                  [selected]="edfeg.data_form_entity.visibility === visibilityOptions.YET_TO_ANNOUNCE"
                >
                  Yet to announce
                </option>
                <option
                  value="{{ visibilityOptions.OPEN_BUT_INVISIBLE }}"
                  [selected]="edfeg.data_form_entity.visibility === visibilityOptions.OPEN_BUT_INVISIBLE"
                >
                  Open but invisible
                </option>
                <option
                  value="{{ visibilityOptions.OPEN }}"
                  [selected]="edfeg.data_form_entity.visibility === visibilityOptions.OPEN"
                >
                  Open to all
                </option>
                <option
                  value="{{ visibilityOptions.CLOSED }}"
                  [selected]="edfeg.data_form_entity.visibility === visibilityOptions.CLOSED"
                >
                  Closed to all
                </option>
                <option
                  value="{{ visibilityOptions.ON_THE_SPOT_UNINVITED }}"
                  [selected]="edfeg.data_form_entity.visibility === visibilityOptions.ON_THE_SPOT_UNINVITED"
                >
                  On the spot uninvited
                </option>
                <option
                  value="{{ visibilityOptions.MEMBERS_WHO_HAVE_ATTENDED }}"
                  [selected]="edfeg.data_form_entity.visibility === visibilityOptions.MEMBERS_WHO_HAVE_ATTENDED"
                >
                  Members who have attended
                </option>
              </select>
            </div>
            <div *appBreakpoints="'>md'">
              <div
                *ngIf="
                  [ERegistationTypes.ATTENDEE, ERegistationTypes.SPEAKER].includes(edfeg.registration_type.name) &&
                  event.editable
                "
              >
                <nb-toggle (checkedChange)="updateRSVP(edfeg.id, i)" [checked]="edfeg.rsvp_open === true">
                  Allow RSVP
                </nb-toggle>
              </div>
            </div>
            <div *appBreakpoints="'<=md'">
              <div *ngIf="event.editable" class="com-mt-2">
                <button
                  (click)="openEmailWindow(edfeg)"
                  class="com-bg-transparent com-border com-border-solid com-border-black com-rounded-md com-p-2"
                >
                  <fa-icon [icon]="faEnvelope"></fa-icon>
                  Send By EMail
                </button>
              </div>
            </div>
          </div>
          <!-- send emails -->
          <div *appBreakpoints="'>md'">
            <div *ngIf="event.editable" class="com-mt-2">
              <button
                (click)="openEmailWindow(edfeg)"
                class="com-bg-transparent com-border com-border-solid com-border-black com-rounded-md com-p-2"
              >
                <fa-icon [icon]="faEnvelope"></fa-icon>
                Send By EMail
              </button>
            </div>
          </div>

          <!-- clone and delete -->
          <div class="com-mt-2 com-flex md:com-flex-col md:com-gap-8 com-justify-between md:com-justify-normal">
            <a nbButton outline size="small" status="primary">
              <fa-icon [icon]="faCopy"></fa-icon>
              &nbsp; Clone Form
            </a>
            <a (click)="deleteEventDataFormEntityGroup(edfeg.id)" nbButton outline size="small" status="danger">
              <fa-icon [icon]="faTimesCircle"></fa-icon>
              &nbsp; Delete
            </a>
          </div>
        </div>
      </nb-list-item>
    </nb-list>
  </div>

  <div *ngIf="event.editable">
    <div class="create-form">
      <div class="text">
        <p class="attach-form-text">Attach a Form</p>
        <p class="sub-text">
          You can add more forms if you want members to fill more information for this event, by filling the form below
        </p>
      </div>
      <!-- <div class="create-form-button">
        <button nbButton (click)="openNewFormWindow()" class="create-button" size="small" status="primary">
          <nb-icon icon="plus-outline"></nb-icon>Create New Form
        </button>
      </div> -->
    </div>
    <form
      (ngSubmit)="createEventDataFormEntityGroup()"
      [formGroup]="eventDataFormEntityGroupForm"
      class="dfeg-create-form"
    >
      <div formGroupName="data_form_entity_group">
        <div class="name">
          <label fullWidth>
            Name*
            <input fieldSize="small" formControlName="name" placeholder="Form Name" fullWidth nbInput type="text" />
            <span
              *ngIf="
                eventDataFormEntityGroupForm.controls.data_form_entity_group.get('name').touched &&
                eventDataFormEntityGroupForm.controls.data_form_entity_group.get('name').invalid &&
                eventDataFormEntityGroupForm.controls.data_form_entity_group.get('name').errors.required
              "
            >
              <commudle-alert [error]="true" [errorMessage]="'Required Field'"></commudle-alert>
            </span>
          </label>
        </div>

        <div class="data-form-type-select">
          <label>
            Select Type*
            <br />
            <div class="select">
              <select
                formControlName="registration_type_id"
                [ngClass]="{
                  'com-text-[#8E9BB3]':
                    eventDataFormEntityGroupForm.controls.data_form_entity_group.get('registration_type_id').value ===
                    ''
                }"
              >
                <option value="" selected disabled>Form Type</option>
                <option *ngFor="let rt of registrationTypes" [value]="rt.id">
                  {{ rt.name | titlecase }}
                </option>
              </select>
            </div>
            <span
              *ngIf="
                eventDataFormEntityGroupForm.controls.data_form_entity_group.get('registration_type_id').touched &&
                eventDataFormEntityGroupForm.controls.data_form_entity_group.get('registration_type_id').invalid &&
                eventDataFormEntityGroupForm.controls.data_form_entity_group.get('registration_type_id').errors.required
              "
            >
              <commudle-alert [error]="true" [errorMessage]="'Please select form type'"></commudle-alert>
            </span>
          </label>
        </div>

        <div class="data-form-select">
          <label>
            Select Form*
            <br />
            <div class="select">
              <select
                formControlName="data_form_id"
                [ngClass]="{
                  'com-text-[#8E9BB3]':
                    eventDataFormEntityGroupForm.controls.data_form_entity_group.get('data_form_id').value === ''
                }"
                (change)="changeDataFormValue($event.target)"
              >
                <option disabled selected value="">Which Form?</option>
                <option value="createNewForm" (click)="openNewFormWindow()"><strong>+</strong> CREATE NEW FORM</option>
                <option *ngFor="let df of communityDataForms" [value]="df.id">
                  {{ df.name | titlecase }}
                </option>
              </select>
            </div>
            <span
              *ngIf="
                eventDataFormEntityGroupForm.controls.data_form_entity_group.get('data_form_id').touched &&
                eventDataFormEntityGroupForm.controls.data_form_entity_group.get('data_form_id').invalid &&
                eventDataFormEntityGroupForm.controls.data_form_entity_group.get('data_form_id').errors.required
              "
            >
              <commudle-alert [error]="true" [errorMessage]="'Please select a form'"></commudle-alert>
            </span>
          </label>
          <a
            *ngIf="eventDataFormEntityGroupForm.get('data_form_entity_group').get('data_form_id').value"
            [routerLink]="[
              '/forms',
              eventDataFormEntityGroupForm.get('data_form_entity_group').get('data_form_id').value,
              'edit'
            ]"
            target="_blank"
          >
            <nb-icon icon="eye" nbTooltip="View Form" status="info"></nb-icon>
          </a>
        </div>
      </div>

      <div class="save-button-bottom">
        <button
          [disabled]="
            !eventDataFormEntityGroupForm.valid ||
            eventDataFormEntityGroupForm.controls.data_form_entity_group.get('data_form_id').value === 'createNewForm'
          "
          fullWidth
          nbButton
          outline
          size="small"
          status="primary"
          type="submit"
        >
          Save
        </button>
      </div>
    </form>
  </div>
</div>

<ng-template #newDataFormTemplate let-data>
  <div class="new-data-form-template">
    <app-new-data-form (newDataForm)="createAndSelectForm($event)" [minQuestionCount]="1"></app-new-data-form>
  </div>
</ng-template>
