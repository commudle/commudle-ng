<div class="data-form-container">
  <div *ngIf="dataFormEntity" class="base-layout fill-data-form">
    <div class="container">
      <div class="two-column-layout wide">
        <div class="main-column">
          <div>
            <nb-card *ngIf="formClosed">
              <nb-card-body> This form is closed! </nb-card-body>
            </nb-card>
          </div>

          <div *ngIf="!formClosed">
            <nb-card class="header">
              <nb-card-body>
                <p *ngIf="community" class="community">
                  <app-community-badge [community]="community"></app-community-badge>
                </p>
                <div *ngIf="event" class="event">
                  <div class="header-image">
                    <commudle-banner-image
                      *ngIf="event.header_image_path"
                      [headerImagePath]="event.header_image_path"
                      [name]="event.name"
                    ></commudle-banner-image>
                  </div>
                  <p class="event-name">{{ event.name }}</p>
                </div>
                <p class="form-name">{{ dataFormEntity.name }}</p>
              </nb-card-body>
            </nb-card>

            <nb-card *ngIf="showProfileForm">
              <nb-card-header> Let's Update Your Basic Profile! </nb-card-header>
              <nb-card-body>
                <div>
                  <app-basic-user-profile></app-basic-user-profile>
                </div>
              </nb-card-body>
            </nb-card>

            <div class="data-form-fill-body">
              <app-data-form-fill
                (formSubmitted)="submitForm($event)"
                [dataFormId]="dataFormEntity.data_form_id"
                [existingResponses]="selectedFormResponse"
                [eventId]="event ? event.id : ''"
                submitButtonText="Submit & Pay"
              >
              </app-data-form-fill>
              <p *ngIf="dataFormEntity.multi_response" class="text-info">
                <i>* You can submit multiple responses for this form!</i>
              </p>
            </div>
          </div>
        </div>
        <div class="right-column payment-details-section" *ngIf="paymentDetails">
          <nb-card *ngIf="ticketPaidAlready">
            <nb-card-body class="!com-p-4">
              <div class="com-text-lg com-font-medium">Ticket Already Paid For</div>
              <div>
                <div
                  *ngFor="let user of eventTicketOrders[0].eto_users"
                  class="com-border-0 com-border-b com-border-solid com-border-Bright-Gray com-p-2"
                >
                  <div>{{ user.name | titlecase }}</div>
                  <div>{{ user.email }}</div>
                </div>
              </div>
            </nb-card-body>
          </nb-card>
          <nb-card *ngIf="!ticketPaidAlready">
            <nb-card-body>
              <div class="payment-deatils !com-flex-col">
                <div class="com-flex com-justify-between">
                  <span class="heading">Price </span>
                  <span class="value">
                    <span class="heading com-mr-2">x{{ forms.length }}</span>
                    <span> {{ paymentDetails.currency === 'inr' ? '₹' : '$' }} {{ basePrice }} </span>
                  </span>
                </div>
                <div class="com-flex com-justify-between com-mt-4">
                  <span class="heading">Sub Total</span>
                  <span class="value"
                    >{{ paymentDetails.currency === 'inr' ? '₹' : '$' }} {{ basePrice * this.forms.length }}</span
                  >
                </div>
              </div>
              <div class="payment-deatils" *ngIf="discountAmount > 0">
                <span class="heading">Discount Amount</span>
                <span class="value">
                  {{ paymentDetails.currency === 'inr' ? '₹' : '$' }}
                  {{ discountAmount }}
                </span>
              </div>
              <div class="payment-deatils" *ngIf="totalTaxAmount > 0">
                <span class="heading">{{ paymentDetails.tax_name }} ({{ paymentDetails.tax_percentage }}%)</span>
                <span class="value">
                  {{ paymentDetails.currency === 'inr' ? '₹' : '$' }}
                  {{ totalTaxAmount }}
                </span>
              </div>

              <div class="payment-deatils">
                <span class="heading">Total</span>
                <span class="value">
                  {{ paymentDetails.currency === 'inr' ? '₹' : '$' }}
                  {{ totalPrice + totalTaxAmount }}
                </span>
              </div>

              <div class="discount-code">
                <span class="heading">Apply Coupon</span>
                <div class="input">
                  <input
                    nbInput
                    type="text"
                    fieldSize="small"
                    [(ngModel)]="promoCode"
                    [readonly]="promoCodeApplied"
                    placeholder="Enter Promo Code"
                  />
                  <button
                    nbButton
                    status="primary"
                    size="tiny"
                    outline
                    (click)="promoCodeApplied ? removePromoCode() : applyPromo()"
                  >
                    {{ promoCodeApplied ? 'Remove' : 'Apply' }}
                  </button>
                </div>
                <span *ngIf="discountAmount > 0" class="code-success">Coupon code applied successfully!</span>
              </div>
              <div class="user-details">
                <span class="com-text-lg com-font-semibold">YOU</span>
                <br />
                <div class="user-detail">
                  <div *ngFor="let form of forms; let i = index">
                    <div (click)="removeUser(i)" *ngIf="i !== 0" class="com-flex com-cursor-pointer">
                      <span class="com-text-red-500 com-mx-auto com-mt-2 com-text-base"> Remove </span>
                    </div>
                    <form [formGroup]="form">
                      <div formGroupName="additional_users">
                        <!-- name -->
                        <label>
                          Name*
                          <input
                            fieldSize="small"
                            formControlName="name"
                            placeholder="Name"
                            fullWidth
                            nbInput
                            type="text"
                            [readonly]="i === 0"
                          />
                          <span
                            *ngIf="
                              form.get('additional_users').get('name').touched &&
                              form.get('additional_users').get('name').invalid &&
                              form.get('additional_users').get('name').errors.required
                            "
                          >
                            <commudle-alert [error]="true" [errorMessage]="'Required Field'"></commudle-alert>
                          </span>
                        </label>

                        <!-- email address -->
                        <label>
                          Email Address*
                          <input
                            fieldSize="small"
                            formControlName="email"
                            placeholder="Email Address"
                            fullWidth
                            nbInput
                            type="email"
                            [readonly]="i === 0"
                          />

                          <span
                            *ngIf="
                              form.get('additional_users').get('email').touched &&
                              form.get('additional_users').get('email').invalid &&
                              form.get('additional_users').get('email').errors.required
                            "
                          >
                            <commudle-alert [error]="true" [errorMessage]="'Required Field'"></commudle-alert>
                          </span>
                        </label>

                        <!-- phone number -->
                        <label>
                          Number*
                          <div class="com-flex com-gap-2">
                            <div class="select">
                              <select
                                id="numberCode"
                                formControlName="phone_country_code"
                                class="com-w-[120px]"
                                [ngClass]="{
                                  'com-text-[#8E9BB3]':
                                    form.get('additional_users').get('phone_country_code').value === ''
                                }"
                              >
                                <option selected disabled value="">Select Country</option>
                                <option *ngFor="let code of countries" [value]="code.phone">
                                  <span> +{{ code.phone }} ({{ code.name }}) </span>
                                </option>
                              </select>
                            </div>
                            <input
                              fieldSize="small"
                              formControlName="phone_number"
                              placeholder="Mobile Number"
                              fullWidth
                              nbInput
                              type="number"
                            />
                          </div>
                          <span
                            *ngIf="
                              form.get('additional_users').get('phone_number').touched &&
                              form.get('additional_users').get('phone_number').invalid &&
                              form.get('additional_users').get('phone_number').errors.required
                            "
                          >
                            <commudle-alert [error]="true" [errorMessage]="'Required Field'"></commudle-alert>
                          </span>
                        </label>
                      </div>
                    </form>
                  </div>
                </div>
                <div class="com-mt-4">
                  <button (click)="addNewUser()" class="add-another-user">+ Add Another Recipient</button>
                </div>
              </div>
            </nb-card-body>
          </nb-card>
          <!-- <div class="com-px-2">
            <button nbButton status="primary" fullWidth (click)="submitForm($event)"> Submit & Pay</button>
          </div> -->
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #paymentDialog let-ref="dialogRef">
  <nb-card>
    <nb-card-header class="com-flex com-justify-between com-items-center">
      <div class="com-flex com-gap-3 com-flex-col">
        <span> Complete Payment</span>
        <div *ngIf="showTimer" class="com-text-xs com-text-red-500">Time Left: {{ formattedTimeRemaining }}</div>
      </div>
      <div>
        <button (click)="ref.close()" ghost nbButton shape="round" size="small">
          <nb-icon icon="close"></nb-icon>
        </button>
      </div>
    </nb-card-header>
    <nb-card-body class="com-min-h-[250px]">
      <ng-container *ngIf="elementsOptions?.clientSecret as clientSecret">
        <ngx-stripe-payment [clientSecret]="clientSecret"> </ngx-stripe-payment>
      </ng-container>
    </nb-card-body>
    <nb-card-footer class="com-flex com-justify-between">
      <button nbButton status="primary" (click)="pay()">Pay</button>
      <button nbButton status="danger" (click)="ref.close()">Cancel</button>
    </nb-card-footer>
  </nb-card>
</ng-template>

<ng-template #formConfirmationDialog let-data>
  <nb-card class="confirmation-dialog">
    <nb-card-body>
      <div>
        <p class="thank-you-icon">
          <nb-icon icon="done-all" status="success"></nb-icon>
        </p>
        <p>Thank You {{ currentUser.name }} for filling the form!</p>
      </div>
    </nb-card-body>
    <nb-card-footer>
      <p *ngIf="event">
        <a [routerLink]="['/communities', community.slug, 'events', event.slug]">
          <img alt="{{ event.name }}" src="{{ event.header_image_path }}" title="{{ event.name }}" />
          <br />
          {{ event.name }}
        </a>
      </p>
      <p *ngIf="community">
        <a [routerLink]="['/communities', community.slug]">
          <img alt="{{ community.name }}" src="{{ community.logo_path }}" title="{{ community.name }}" />
          <br />
          {{ community.name }}
        </a>
      </p>
      <p>
        <a [routerLink]="['/']">
          <nb-icon icon="home"></nb-icon>
          <br />
          Home
        </a>
      </p>
    </nb-card-footer>
  </nb-card>
</ng-template>

<ng-template #paymentErrorDialog let-data let-ref="dialogRef">
  <nb-card>
    <nb-card-body>
      <p class="com-text-base com-font-semibold">{{ data | capitalizeAndRemoveUnderscore }}</p>
      <button nbButton status="base" (click)="reload(); ref.close()">
        <fa-icon [icon]="faIcon.faArrowRight"></fa-icon> Refresh
      </button>
    </nb-card-body>
  </nb-card>
</ng-template>
